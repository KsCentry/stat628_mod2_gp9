---
title: "module_2_analysis"
output: html_document
---

```{r setup, include=FALSE}
library(corrplot)
library(dplyr)
library(ggplot2)
```

# Data load and summary

```{r}
BodyFat = read.csv("../data/BodyFat.csv")
summary(BodyFat)
```
Box plot of 3 suspect variables

```{r}
layout(matrix(c(1:3), nrow = 1, ncol = 3, byrow = TRUE))

boxplot(BodyFat$ADIPOSITY,
        main = "Boxplot for Adiposity",
        ylab = "Adiposity",
        col = "lightblue",
        outline = TRUE)

boxplot(BodyFat$ABDOMEN,
        main = "Boxplot for Abdomen",
        ylab = "Abdomen",
        col = "lightblue",
        outline = TRUE)
boxplot(BodyFat$HEIGHT,
        main = "Boxplot for Height",
        ylab = "Height",
        col = "lightblue",
        outline = TRUE)
```
# Data cleaning

Data Cleaning for Body Fat Prediction:
**Remove BMI Outliers**:
We filter out any observations with BMI > 40 to avoid skewing the regression model with extreme values.

**Update Height for Sample 42**:
For sample 42, which has an abnormally low height, we recalculate height using the recorded BMI and weight to ensure data consistency.

**Re-estimate Low Body Fat**:
For individuals with body fat < 7%, we use a linear regression model trained on data where body fat â‰¥ 7% to provide more reasonable estimates.

```{r}
BodyFat = BodyFat[!(BodyFat$ADIPOSITY > 40), ]
BodyFat[42, ]$HEIGHT = sqrt(BodyFat[42, ]$WEIGHT / BodyFat[42, ]$ADIPOSITY * 703)

low_bodyfat_index = which(BodyFat$BODYFAT < 7)
model <- lm(BODYFAT ~ AGE + ADIPOSITY + ABDOMEN + CHEST + HIP + THIGH,
            data = BodyFat[BodyFat$BODYFAT >= 7, ])
predicted_bodyfat = predict(model, newdata = BodyFat[low_bodyfat_index, ])
BodyFat$BODYFAT[low_bodyfat_index] <- predicted_bodyfat

write.csv(BodyFat, file = "../data/BodyFat_cleaned.csv", row.names = FALSE)
write.csv(BodyFat, file = "../code/shiny_app/BodyFat_cleaned.csv", row.names = FALSE)
```


# Varible selection

BMI (Body Mass Index) is calculated from height and weight, so including all three variables would introduce redundancy and potential multicollinearity. By keeping only BMI, we retain the information about the relationship between height and weight in a single variable.

DENSITY is impossible to evaluate in practice, remove it as well.

```{r}
BodyFat_cleaned = read.csv("../data/BodyFat_cleaned.csv")
BodyFat_cleaned <- subset(BodyFat_cleaned, select = -c(WEIGHT, HEIGHT, IDNO, DENSITY))
```

## Correlation Matrix of Circumference Varibles

```{r}
cor_matrix = cor(BodyFat[8:17])

par(mar = c(5, 4, 4, 2) + 0.1)
corrplot(cor_matrix, method = "color", type = "lower", 
         tl.col = "black", tl.srt = 30, 
         col = colorRampPalette(c("white", "lightcoral", "red", "darkred"))(100),
         title = "Correlation Matrix", 
         mar = c(0, 0, 2, 0),
         col.lim = c(0, 1))

BodyFat_cleaned <- subset(BodyFat_cleaned, select = -c(ANKLE, FOREARM))
```

I removed the variables **ANKLE** and **FOREARM** based on their relatively low correlations, as shown in the correlation matrix. These variables displayed lighter colors. By eliminating variables with low correlations, I aimed to focus on variables that contribute more significantly to the model.


During some regression attempts, we find that there are strong correlation (0.916) between ADIPOSITY and ABDOMEN, and the regression coefficient of ABDOMEN is significant, so ADIPOSITY is eliminated.

```{r}
plot(BodyFat_cleaned$ADIPOSITY, BodyFat_cleaned$ABDOMEN,
     xlab = "BMI", ylab = "ABDOMEN")
abline(lm(BodyFat_cleaned$ABDOMEN ~ BodyFat_cleaned$ADIPOSITY), col = "red")
BodyFat_cleaned <- subset(BodyFat_cleaned, select = -ADIPOSITY)
```
## VIF

```{r}
library(car)
library(cvTools)

model <- lm(BODYFAT ~ NECK + CHEST + ABDOMEN + HIP + THIGH + KNEE + BICEPS + WRIST, data = BodyFat_cleaned)
summary(model)
print(vif(model))
BodyFat_cleaned <- subset(BodyFat_cleaned, select = -THIGH)
```
It might be more reasonable to remove THIGH first, as it has both a high p-value (indicating low significance) and a moderately high VIF (5.799). This way, you reduce multicollinearity without sacrificing too much statistical significance.


## Stepwise regression

```{r}
stepwise_model <- step(model, direction = "backward")
summary(stepwise_model)
```

Stepwise regression is a method used to simplify a regression model by automatically selecting the most relevant variables, either by adding or removing them, based on certain criteria like the **Akaike Information Criterion (AIC)** or **p-values**. The goal is to improve the model's performance by retaining only the variables that provide the most explanatory power and removing those that do not significantly contribute to the model. 

**backward elimination**, which systematically removed the least significant variables until the remaining set of predictors had strong statistical justification for staying in the model.

After performing stepwise backward elimination, the final model retained four key variables: **CHEST**, **ABDOMEN**, **HIP**, and **WRIST**. 

- **ABDOMEN** (p-value < 2e-16): This variable is the most significant predictor of body fat percentage, with a strong positive coefficient. It suggests that abdominal measurements are highly correlated with body fat.
  
- **WRIST** (p-value = 2.88e-06): WRIST circumference also shows strong significance with a large negative coefficient, indicating its importance in predicting body fat.
  
- **HIP** (p-value = 0.0136): HIP showed some multicollinearity concerns earlier, we consider to drop it in this step.
  
- **CHEST** (p-value = 0.0671): While marginally significant, CHEST contributes weakly to the model but was still retained, possibly due to its relation to body fat distribution in the upper body, drop it as well

We retain ABDOMEN and WRIST at last.



```{r}
BodyFat_cleaned <- subset(BodyFat_cleaned, select = -c(HIP, CHEST, NECK, KNEE, BICEPS))
model_AW = lm(BODYFAT ~ ABDOMEN + WRIST, data = BodyFat_cleaned)
summary(model_AW)
```

## Check if age helps model prediction.

```{r}
model_AW_AGE = lm(BODYFAT ~ ABDOMEN + WRIST + AGE, data = BodyFat_cleaned)
summary(model_AW_AGE)
```
The coefficient  of age is significant, retain it.

Our final model: BODYFAT ~ ABDOMEN + WRIST + AGE

# GRAPHS

TO BE FINISHED

```{r}
mse = function(model){
  return (mean(model$residuals^2))
}

model_metrics <- data.frame(
  Model = c("model_BMI_ABDOMEN_Age", "model_BMI_ABDOMEN", "model_BMI", "model_BACHW"),
  R2 = c(summary(model_BMI_ABDOMEN_Age)$r.squared, 
         summary(model_BMI_ABDOMEN)$r.squared, 
         summary(model_BMI)$r.squared, 
         summary(model_BACHW)$r.squared),  
  MSE = c(mse(model_BMI_ABDOMEN_Age), 
          mse(model_BMI_ABDOMEN), 
          mse(model_BMI), 
          mse(model_BACHW))
)
```

```{r}
ggplot(model_metrics, aes(x = MSE, y = R2, color = Model, label = Model)) +
  geom_point(size = 3) +               
  labs(title = "MSE vs R^2 for Different Models", x = "Mean Squared Error (MSE)", y = "R^2") +
  scale_x_continuous(limits = c(15, 30)) +  
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal() +
  theme(legend.position = "right") 
```


```{r}
predicted_values = predict(model_BMI_ABDOMEN_Age, BodyFat_cleaned)
ggplot(BodyFat_cleaned, aes(x = BODYFAT, y = predicted_values)) +
  geom_point(color = "blue") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(title = "Actual vs Predicted Body Fat", x = "Actual Body Fat (%)", y = "Predicted Body Fat (%)") +
  theme_minimal()
```

```{r}
 # Residual plot
residuals = model_BMI_ABDOMEN_Age$residuals
ggplot(BodyFat_cleaned, aes(x = predict(model_BMI_ABDOMEN_Age), y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residual Plot", x = "Predicted Values", y = "Residuals") +
  theme_minimal()

```

```{r}
ggplot() +
  geom_histogram(aes(x = BodyFat_cleaned$BODYFAT), fill = "blue", alpha = 0.5, bins = 30) +
  geom_histogram(aes(x = predicted_values), fill = "green", alpha = 0.5, bins = 30) +
  labs(title = "Distribution of Actual vs Predicted Body Fat", x = "Body Fat (%)", y = "Count") +
  theme_minimal()
```

```{r}
ggplot(data = data.frame(residuals), aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line() + 
  labs(title = "Q-Q Plot of Residuals for Body Fat Model",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()
```

```{r}
# Pii's value chart 
pii_BA = hatvalues(model_BMI_ABDOMEN_Age)
par(mfrow = c(2,1))
n = dim(BodyFat_cleaned)[1]
plot(1:n,pii_BA,type="p",pch=19,cex=1,cex.lab=1.5,
     xlab="Index (Each Observation)",ylab="Pii",main="Leverage Values (Pii for BodyFat and Adiposity)")

# Cook's distance chart 
cooki_BA = cooks.distance(model_BMI_ABDOMEN_Age)
plot(1:n,cooki_BA,type="p",pch=19,cex=1,cex.lab=1.5,
     xlab="Index (Each Observation)",ylab="Cook's Distance",main="Influence Values (Cook's Distance for BodyFat and Adiposity)")
```
